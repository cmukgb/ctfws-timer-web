{% extends "base.html" %}

{% block scripts %}
    <!-- Inserts a <script> containing all the MQTT JavaScript common to this
         and the timer page -->
    {% include "mqtt.html" %}

    <script>
      {% if DEBUG %}
          "use strict";
      {% endif %}

      var totalsLocked = true; // Whether the stuff count totals are disabled
      var vmFlagsPane; // Vue instance for the flag tracking pane

      // Split off the first line of the input and replace any remaining
      // newlines with semicolons
      function formatResult(str) {
        var split = str.trim().split(/\n+/);
        if (split.length > 1) {
          var first = split.shift();
          return [first, split.join("; ")];
        } else {
          return [split[0], ""];
        }
      }

      function postForm(e) {
        e.preventDefault(); // Prevent normal form submission

        var error = false;

        // Check each element within the form that has class input-required.
        // Setting has-feedback is recommended by Bootstrap, but it adds
        // excessive padding that cuts off the text in the input. Looking
        // through the Bootstrap CSS, it doesn't appear to do anything we need,
        // so we won't add it.
        $(".input-required", this).each(function () {
          if ($.trim(this.value) === "") {
            error = true;
            // $(this).closest(".form-group").addClass("has-feedback");
            $(this).closest(".form-group").addClass("has-error");
          } else {
            $(this).closest(".form-group").removeClass("has-error");
            // $(this).closest(".form-group").removeClass("has-feedback");
          }
        });

        $(".radio-required", this).each(function () {
          if ($("input:radio:checked", this).length < 1) {
            error = true;
            $(this).closest(".form-group").addClass("has-error");
          } else {
            $(this).closest(".form-group").removeClass("has-error");
          }
        });

        if (!error) {
          $("#commandResult").removeClass("text-success");
          $("#commandResult").removeClass("text-danger");
          $("#commandResult").addClass("text-primary");
          $("#firstCommandResult").text("Sending...");
          $("#extraCommandResults").text("");

          var result = $.post($(this).attr("action"), $(this).serialize());

          result.done(function (response) {
            $("#commandResult").removeClass("text-primary");
            $("#commandResult").removeClass("text-danger");
            $("#commandResult").addClass("text-success");
            var split = formatResult(response);
            $("#firstCommandResult").text(split[0]);
            $("#extraCommandResults").text(split[1]);
          });
          result.fail(function (response) {
            var errorMessage = response.responseText.trim();
            if (errorMessage === "") {
              errorMessage = "Unknown error. (The server may be unreachable.)"
            }
            $("#commandResult").removeClass("text-primary");
            $("#commandResult").removeClass("text-success");
            $("#commandResult").addClass("text-danger");
            var split = formatResult(errorMessage);
            $("#firstCommandResult").text(split[0]);
            $("#extraCommandResults").text(split[1]);
          });
          // $(this)[0].reset(); // Use [0] to get the underlying DOM object
        }
      }

      function updateInputColor() {
        var cell = $(this).parent();
        var inputs = cell.children("input");
        var top = parseInt(inputs[0].value);
        var bottom = parseInt(inputs[1].value);
        cell.removeClass("success");
        cell.removeClass("success-dark");
        if (!isNaN(top) && !isNaN(bottom)) {
          if (top === bottom) {
            cell.addClass("success");
          } else if (top > bottom) {
            cell.addClass("success-dark");
          }
        }
      }

      function postStuffForm() {
        var message = $("#saveTotalsResult");
        message.removeClass("text-success");
        message.removeClass("text-danger");
        message.removeClass("text-warning");
        message.text("Saving...");
        var result = $.post($("#stuffForm").attr("action"),
          $("#stuffForm").serialize());
        result.done(function () {
          message.addClass("text-success");
          message.text("Saved!");
        });
        result.fail(function (response) {
          message.addClass("text-danger");
          message.text("Error: " + response.responseText);
        });
      }

      function setUnsavedMessage() {
        var message = $("#saveTotalsResult");
        message.removeClass("text-danger");
        message.removeClass("text-success");
        message.addClass("text-warning");
        message.text("Unsaved changes");
      }

      function clearStuffFormCounts() {
        $("#stuffTables td").each(function () {
          var numer = $("input", this).get(0); // Get the 1st input in the td
          if (typeof numer !== "undefined") {
            numer.value = "";
            $(numer).trigger("input");
          }
        });
      }

      function toggleStuffTotalsLock() {
        totalsLocked = !totalsLocked;
        updateStuffTotalsDisabledState();
      }

      function updateStuffTotalsDisabledState() {
        $("#stuffTables td").each(function () {
          var denom = $("input", this).get(1); // Get the 2nd input in the td
          if (typeof denom !== "undefined") {
            if (totalsLocked) {
              $(denom).attr("disabled", "");
            } else {
              $(denom).removeAttr("disabled");
            }
          }
        });
        if (totalsLocked) {
          $("#lockUnlockText").text("Unlock");
        } else {
          $("#lockUnlockText").text("Lock");
        }
      }

      // Show the spans for the selected message type and hide the other spans
      function showCurrentMessageSpans() {
        $("#playerMessageTimeSpan").addClass("hidden");
        $("#jailMessageTimeSpan").addClass("hidden");
        $("#bothMessageTimeSpan").addClass("hidden");
        $("#playerMessageSpan").addClass("hidden");
        $("#jailMessageSpan").addClass("hidden");
        $("#bothMessageSpan").addClass("hidden");
        $("#" + this.value + "MessageTimeSpan").removeClass("hidden");
        $("#" + this.value + "MessageSpan").removeClass("hidden");
      }

      function setupTabHooks() {
        var tabPaneStr = 'TabPane';
        function showHashedTab() {
          $('a[href="' + location.hash + tabPaneStr + '"]').tab('show');
        }
        function setHash(activeTabSelector) {
          var newHash = ('#' + $(activeTabSelector).attr('href')
              .slice(1, -1 * tabPaneStr.length));
          if (newHash !== location.hash) {
            if (history.pushState) {
              history.pushState(null, null, newHash);
            } else {
              location.hash = newHash;
            }
          }
        }
        // Show active tab on reload and set the default if not present
        if (location.hash !== '') {
          showHashedTab();
        } else {
          setHash('li.active>a[data-toggle="tab"]');
        }
        // Show the right tab on back button too
        window.onpopstate = function() {
          showHashedTab();
        };
        // Remember the hash in the URL without jumping
        $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
          setHash(e.target);
        });
      }

      function updateVueNumFlags(numFlagsStr) {
        var numFlags = parseInt(numFlagsStr);
        if (!isNaN(numFlags)) {
          if (vmFlagsPane) {
            vmFlagsPane.numFlags = numFlags;
          } else {
            console.warn("Flags Pane Vue instance is undefined.");
          }
        } else {
          console.error("Non-integer number of flags: " + numFlagsStr);
        }
      }

      // Called when an MQTT message arrives
      function onMessageArrived(message) {
        console.info("onMessageArrived: " + message.destinationName + ": " +
            message.payloadString);
        $("#errorMessage").removeClass("text-danger");
        $("#errorMessage").text("");
        // In all the below cases, when we set a span containing a timestamp,
        // we also set a tooltip showing the human-readable string. Normally
        // this would be set in the "title" attribute, but the Bootstrap
        // tooltip library ignores dynamically set titles, so we sidestep it
        // and use "data-original-title" which is what Bootstrap checks.
        var msg = message.payloadString;
        var topic = message.destinationName.substring(11);
        switch (topic) {
          case 'config':
            if (msg === "none") {
              updateVueNumFlags("0");
              $("#startTimeSpan").text("none");
              $("#numFlagsSpan").text("");
              $("#gameNumSpan").text("");
              $("#territorySpan").html("&nbsp;");
            } else {
              var split = splitOnWhitespace(msg, 7);
              updateVueNumFlags(split[4]);
              $("#startTimeSpan").text(split[0]);
              $("#startTimeSpan").attr("data-original-title",
                secsToTimeString(split[0]));
              $("#numFlagsSpan").text(split[4]);
              $("#gameNumSpan").text(split[5]);
              $("#territorySpan").text(split[6]);
            }
            break;
          case 'flags':
            var split = splitOnFirstWhitespace(msg);
            // Ignore split[0] which is the timestamp
            var flags = split[1];
            if (flags === "?") {
              $("#hiddenFlagsSpan").text("?");
              $("#redFlagsSpan").text("");
              $("#yellowFlagsSpan").text("");
            } else {
              var flagsSplit = splitOnWhitespace(flags, 2);
              $("#hiddenFlagsSpan").text("");
              $("#redFlagsSpan").text(flagsSplit[0]);
              $("#yellowFlagsSpan").text(flagsSplit[1]);
            }
            break;
          case 'endtime':
            $("#endTimeSpan").text(msg);
            $("#endTimeSpan").attr("data-original-title",
              secsToTimeString(msg));
            break;
          // In all three message cases, append a non-breaking space so that
          // empty messages don't change the page layout.
          case 'message':
            var split = splitOnFirstWhitespace(msg);
            $("#bothMessageTimeSpan").text(split[0]);
            $("#bothMessageTimeSpan").attr("data-original-title",
              secsToTimeString(split[0]));
            $("#bothMessageSpan").text(split[1]);
            $("#bothMessageSpan").append("&nbsp;");
            break;
          case 'message/player':
            var split = splitOnFirstWhitespace(msg);
            $("#playerMessageTimeSpan").text(split[0]);
            $("#playerMessageTimeSpan").attr("data-original-title",
              secsToTimeString(split[0]));
            $("#playerMessageSpan").text(split[1]);
            $("#playerMessageSpan").append("&nbsp;");
            break;
          case 'message/jail':
            var split = splitOnFirstWhitespace(msg);
            $("#jailMessageTimeSpan").text(split[0]);
            $("#jailMessageTimeSpan").attr("data-original-title",
              secsToTimeString(split[0]));
            $("#jailMessageSpan").text(split[1]);
            $("#jailMessageSpan").append("&nbsp;");
            break;
          case 'messagereset':
            $("#hideMessagesTimeSpan").text(msg);
            $("#hideMessagesTimeSpan").attr("data-original-title",
              secsToTimeString(msg));
            break;
          default:
            console.error("Unknown topic: " + message.destinationName);
        }
      }

      // Called when MQTT fails to connect or the connection is lost
      function onConnectionError() {
        console.info("onConnectionError");
        $("#errorMessage").addClass("text-danger");
        $("#errorMessage").text("Error connecting to the server");
      }

      var ctfwsTopicTreeComponent = {
        name: 'ctfws-topic-tree',
        delimiters: ['[[', ']]'], // Use these since Django uses { { } }
        template: '#ctfwsTopicTreeTemplate',
        props: {
          topics: {
            type: Object,
            required: true,
          },
          topicName: {
            type: String,
            required: true,
          },
          fullName: {
            type: String,
            required: true,
          },
        },
        data: function() {
          return {
            collapsed: false,
          };
        },
        computed: {
          collapseId: function() {
            var id = 'topic-tree-' + this.fullName
            return id.replace(/\$/g, '');
          },
        },
      };

      $(document).ready(function () {
        // Enable all Bootstrap popovers
        $("[data-toggle='tooltip']").tooltip();

        // Form submit actions
        $(".form-ajax-submit").submit(postForm);
        $(".form-no-submit").submit(function (e) {e.preventDefault();});

        // Message type changes
        $("input[name='message_type']").change(showCurrentMessageSpans);

        // Stuff table cell coloring
        $("#stuffTables input").on("input", updateInputColor);

        // Stuff table "unsaved changes" message
        $("#stuffTables input:last-child").on("input", setUnsavedMessage);

        // Stuff table buttons
        $("#clearCountsButton").click(clearStuffFormCounts);
        $("#lockTotalsButton").click(toggleStuffTotalsLock);
        $("#saveTotalsButton").click(postStuffForm);
        updateStuffTotalsDisabledState(); // Update based on the initial value

        setupTabHooks();

        if (typeof Vue === "undefined") {
          console.error("Failed to setup Vue");
          return;
        }

        // Vue plugin to store certain instance data in localStorage.
        // Adds the 'storage' property to the Vue instance.
        Vue.use(vuejsStorage);

        // This is a global variable so that it can be used in the global
        // onMessageArrived().
        vmFlagsPane = new Vue({
          el: '#flagsPanel', // Have Vue use the flags panel as its template
          delimiters: ['[[', ']]'], // Use these since Django uses { { } }
          data: {
            numFlags: 0,
            flags: [],
          },
          // Used by vuejs-storage: The Vue data keys specified in "keys" will
          // persist accross page loads (see window.localStorage).
          storage: {
            keys: ['flags'],
            namespace: 'ctfws-judge',
          },
          created: function() {
            // Start with numFlags === flags.length so the alert doesn't pop up
            // and then disappear. Very quickly, numFlags should be updated to
            // the broker value. If that doesn't happen, it's probably best to
            // just show the current table without an alert anyways.
            this.numFlags = this.flags.length;
          },
          watch: {
            numFlags: function() {
              if (this.flags.length === 0) {
                this.fillFlagsArray();
              }
            },
          },
          methods: {
            fillFlagsArray: function() {
              this.flags = [];
              for (var i = 0; i < this.numFlags; i++) {
                this.flags.push({
                  letter: String.fromCharCode('A'.charCodeAt(0) + i),
                  red: false,
                  yellow: false,
                });
              }
            },
            uncheckFlagsArray: function() {
              this.flags.forEach(function(flag) {
                flag.red = false;
                flag.yellow = false;
              });
            },
          },
        });

        var vmBrokerTab = new Vue({
          el: '#brokerTabPane', // Have Vue use the broker tab as its template
          delimiters: ['[[', ']]'], // Use these since Django uses { { } }
          components: {
            'ctfws-topic-tree': ctfwsTopicTreeComponent,
          },
          data: {
            topics: {
              value: '',
              children: {}, // Nested version of this same object
            },
            errorConnecting: false,
          },
          // Called after the Vue instance is created
          created: function() {
            // Setup the MQTT client and connect. This function is defined in
            // mqtt.html, which is included above. This defines mqttClient as
            // the global variable for the client connection.
            initMqtt(this.onMessageArrived, this.onConnectionError, true);
          },
          computed: {
          },
          methods: {
            onMessageArrived: function(message) {
              // console.info("[Vue Broker] onMessageArrived: " +
              //     message.destinationName + ": " + message.payloadString);
              this.errorConnecting = false;

              // If this is a game message, also pass it to the above handler.
              if (message.destinationName.indexOf('ctfws/game/') === 0) {
                onMessageArrived(message);
              }

              var parentTopic = this.topics;
              message.destinationName.split('/').forEach(function(topicStr) {
                if (!parentTopic.children.hasOwnProperty(topicStr)) {
                  Vue.set(parentTopic.children, topicStr, {
                    value: '',
                    children: {},
                  });
                }
                parentTopic = parentTopic.children[topicStr];
              });
              parentTopic.value = message.payloadString;

              if (vmDevicesTab && vmDevicesTab.onMessageArrived) {
                vmDevicesTab.onMessageArrived(message);
              }
            },
            onConnectionError: function() {
              this.errorConnecting = true;
              onConnectionError();
              if (vmDevicesTab && vmDevicesTab.onConnectionError) {
                vmDevicesTab.onConnectionError();
              }
            },
          },
        });

        var vmDevicesTab = new Vue({
          el: '#devicesTabPane', // Have Vue use the devices tab as its template
          delimiters: ['[[', ']]'], // Use these since Django uses { { } }
          data: {
            serverNow: getServerNow(),
            devices: {},
            timesync: null,
            errorConnecting: false,
          },
          created: function() {
            // Update the "now" variable every updateNowIntervalTime. Vue will
            // react to this change and update all UI that uses them.
            var vm = this;
            setInterval(function() {
              vm.serverNow = getServerNow();
            }, updateNowIntervalTime);
          },
          computed: {
            staleThreshold: function() {
              return 60; // Seconds
            },
            timesyncFormatted: function() {
              var secs = parseInt(this.timesync);
              if (!isNaN(secs) && secs >= 0) {
                return new Date(secs * 1000).toLocaleString();
              } else {
                return '';
              }
            },
            serverNowFormatted: function() {
              if (this.serverNow) {
                return new Date(this.serverNow * 1000).toLocaleString();
              } else {
                return '';
              }
            },
            deviceRows: function() {
              var devices = this.devices;
              var vm = this;
              var rows = Object.keys(devices).map(function(deviceName) {
                var topics = devices[deviceName];
                var offset = 0;
                var timeStr = '';
                var timeInt = parseInt(topics.time);
                if (!isNaN(timeInt)) {
                  offset = vm.serverNow - timeInt;
                  timeStr = secsToTimeString(timeInt) +
                    ' (' + toHMSWords(offset) + ' ago)';
                } else {
                  timeStr = topics.time;
                }
                var classStr = '';
                if (topics.status === 'dead') {
                  classStr = 'danger';
                } else if (offset > vm.staleThreshold) {
                  classStr = 'warning';
                }
                return {
                  name: deviceName,
                  time: timeStr,
                  status: topics.status,
                  mac: topics.mac,
                  role: topics.role,
                  location: topics.location,
                  offset: offset,
                  class: classStr,
                };
              });
              rows.sort(function(a, b) {
                if (a.name < b.name) {
                  return -1;
                }
                if (a.name > b.name) {
                  return 1;
                }
                return 0;
              });
              return rows;
            },
            yellowBadges: function() {
              var vm = this;
              var staleRows = this.deviceRows.filter(function(row) {
                return row.status !== 'dead' &&
                  row.offset > vm.staleThreshold;
              });
              return staleRows.length;
            },
            redBadges: function() {
              var deadRows = this.deviceRows.filter(function(row) {
                return row.status === 'dead';
              });
              return deadRows.length;
            },
          },
          watch: {
            deviceRows: function() {
              function setBadge(selector, value) {
                if (value) {
                  $(selector).text(value);
                  $(selector).removeClass('hidden');
                } else {
                  $(selector).text('');
                  $(selector).addClass('hidden');
                }
              }
              setBadge('#devicesRedBadgeCount', this.redBadges);
              setBadge('#devicesYellowBadgeCount', this.yellowBadges);
            },
          },
          methods: {
            onMessageArrived: function(message) {
              // console.info("[Vue Devices] onMessageArrived: " +
              //     message.destinationName + ": " + message.payloadString);
              this.errorConnecting = false;

              if (message.destinationName === 'ctfws/timesync') {
                this.timesync = message.payloadString;
              }

              var devPrefix = 'ctfws/dev/';
              var devcPrefix = 'ctfws/devc/';
              var fullTopic = message.destinationName;
              var deviceTopic = '';
              if (fullTopic.indexOf(devPrefix) === 0) {
                deviceTopic = fullTopic.substring(devPrefix.length);
              }
              if (fullTopic.indexOf(devcPrefix) === 0) {
                deviceTopic = fullTopic.substring(devcPrefix.length);
              }
              if (deviceTopic) {
                var split = deviceTopic.split('/');
                if (split.length !== 2) {
                  console.error("Could not parse device subtopic: " +
                      fullTopic);
                } else {
                  var deviceName = split[0];
                  var leafTopic = split[1];
                  if (!deviceName) {
                    console.error("Empty device name in topic: " + fullTopic);
                  } else {
                    if (!this.devices.hasOwnProperty(deviceName)) {
                      Vue.set(this.devices, deviceName, {
                        time: '',
                        status: '',
                        mac: '',
                        role: '',
                        location: '',
                      });
                    }
                    var deviceObject = this.devices[deviceName];
                    if (leafTopic === 'beat') {
                      var beatArgs = message.payloadString.split(/\s+/);
                      deviceObject.status = beatArgs[0];
                      function hasBeatArg(s) {
                        return typeof s !== 'undefined' && s !== '-';
                      }
                      if (hasBeatArg(beatArgs[1])) {
                        deviceObject.time = beatArgs[1];
                      } else {
                        deviceObject.time = '';
                      }
                      if (hasBeatArg(beatArgs[2])) {
                        deviceObject.mac = beatArgs[2];
                      } else {
                        deviceObject.mac = '';
                      }
                    } else if (leafTopic === 'role') {
                      deviceObject.role = message.payloadString;
                    } else if (leafTopic === 'location') {
                      deviceObject.location = message.payloadString;
                    } else {
                      console.error("Unknown device subtopic: " + fullTopic);
                    }
                  }
                }
              }
            },
            onConnectionError: function() {
              this.errorConnecting = true;
            },
          },
        });

        // Activate clipboard.js on the copy buttons in the judges tab.
        new ClipboardJS('.assignments-copy-btn');

        var vmJudgesTab = new Vue({
          el: '#judgesTabPane', // Have Vue use the judges tab as its template
          delimiters: ['[[', ']]'], // Use these since Django uses { { } }
          data: {
            roles: [
              { display: 'Head', key: 'head' },
              { display: 'DH Jail', key: 'dh_jail' },
              { display: 'DH Roam 1', key: 'dh_roam_1' },
              { display: 'DH Roam 2', key: 'dh_roam_2' },
              { display: 'WeH Jail', key: 'weh_jail' },
              { display: 'WeH Roam 1', key: 'weh_roam_1' },
              { display: 'WeH Roam 2', key: 'weh_roam_2' },
              { display: 'On Call', key: 'on_call' },
              { display: 'Playing', key: 'playing' },
              { display: 'Exec', key: 'exec' },
            ],
            assignments: [
            {% for game in game_assignments %}
              {
                head: '{{ game.head }}',
                dh_jail: '{{ game.dh_jail }}',
                dh_roam_1: '{{ game.dh_roam_1 }}',
                dh_roam_2: '{{ game.dh_roam_2 }}',
                weh_jail: '{{ game.weh_jail }}',
                weh_roam_1: '{{ game.weh_roam_1 }}',
                weh_roam_2: '{{ game.weh_roam_2 }}',
                on_call: '{{ game.on_call }}',
                playing: '{{ game.playing }}',
                exec: '{{ game.exec_people }}',
              },
            {% endfor %}
            ],
            editing: false,
            changes: false,
            saving: false,
            successMessage: '',
            errorMessage: '',
            copySupported: ClipboardJS.isSupported(),
          },
          created: function() {
            var vm = this;
            window.addEventListener('beforeunload', function(e) {
              if (vm.changes) {
                e.preventDefault(); // Cancel the event
                e.returnValue = ''; // Chrome requires returnValue to be set
              }
            });
          },
          computed: {
            copyText: function() {
              var vm = this;
              return vm.assignments.map(function(game, index) {
                var rolesArray = vm.roles.map(function(role) {
                  return role.display.toUpperCase() + ': ' + game[role.key];
                });
                return 'GAME ' + (index + 1) + ':\n' + rolesArray.join('\n');
              });
            },
            formData: function() {
              var assignments = this.assignments.map(function(a) {
                return {
                  {{ game_form.head.html_name }}: a.head,
                  {{ game_form.dh_jail.html_name }}: a.dh_jail,
                  {{ game_form.dh_roam_1.html_name }}: a.dh_roam_1,
                  {{ game_form.dh_roam_2.html_name }}: a.dh_roam_2,
                  {{ game_form.weh_jail.html_name }}: a.weh_jail,
                  {{ game_form.weh_roam_1.html_name }}: a.weh_roam_1,
                  {{ game_form.weh_roam_2.html_name }}: a.weh_roam_2,
                  {{ game_form.on_call.html_name }}: a.on_call,
                  {{ game_form.playing.html_name }}: a.playing,
                  {{ game_form.exec_people.html_name }}: a.exec,
                };
              });
              return {
                command: 'save_assignments',
                assignments: JSON.stringify(assignments),
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val(),
              };
            },
          },
          watch: {
            assignments: {
              deep: true,
              handler: function() {
                this.changes = true;
                this.successMessage = '';
              },
            },
          },
          methods: {
            saveAssignments: function() {
              var vm = this;
              vm.successMessage = '';
              vm.errorMessage = '';
              vm.saving = true;
              var result = $.post({% url 'judge' %}, vm.formData);
              result.done(function (response) {
                vm.saving = false;
                vm.editing = false;
                vm.changes = false;
                vm.successMessage = 'Saved!';
              });
              result.fail(function (response) {
                vm.saving = false;
                var unknown = 'Unknown error (the server may be unreachable)';
                var error = response.responseText.trim();
                vm.errorMessage = error ? 'Error: ' + error : unknown;
              })
            },
            clearAssignments: function() {
              if (window.confirm('Clear all assignments?')) {
                this.assignments.forEach(function(game) {
                  Object.keys(game).forEach(function(role) {
                    game[role] = '';
                  });
                });
              }
            },
            tableDataClasses: function(role, index) {
              function roleContains(building) {
                return role.key.indexOf(building) >= 0;
              }
              var weh = roleContains('weh');
              var dh = roleContains('dh');
              var isEven = index % 2 === 0;
              return {
                info: role.key === 'head',
                warning: (isEven && weh) || (!isEven && dh),
                danger: (!isEven && weh) || (isEven && dh),
              };
            },
          },
        });

        console.info("Finished setup");
      });
    </script>

    <!-- This is the template HTML for the <ctfws-topic-tree> component -->
    <script type="text/x-template" id="ctfwsTopicTreeTemplate">
      <div>
        <table v-if="topicName || topics.value" class="topic-tree-table">
          <tr>
            <td :class="{ invisible: !Object.keys(topics.children).length }">
              <a data-toggle="collapse" :data-target="'#' + collapseId"
                  aria-expanded="true"
                  :aria-controls="'#' + collapseId"
                  href="javascript:void(0)"
                  @click="collapsed = !collapsed">
                <span
                    v-if="collapsed"
                    class="glyphicon glyphicon-menu-right"
                    aria-hidden="true">
                </span>
                <span
                    v-else
                    class="glyphicon glyphicon-menu-down"
                    aria-hidden="true">
                </span>
              </a>
            </td>
            <td>[[ topicName ]]:</td>
            <td>[[ topics.value ]]</td>
          </tr>
        </table>
        <div :id="collapseId" class="collapse in">
          <ctfws-topic-tree
              v-for="(childTopic, childTopicName) in topics.children"
              :key="fullName + childTopicName + '-'"
              :topics="childTopic"
              :topic-name="childTopicName"
              :full-name="fullName + childTopicName + '-'"
              class="indent-tree">
          </ctfws-topic-tree>
        </div>
      </div>
    </script>
{% endblock %}

{% block title %}
    CtFwS Judges
{% endblock %}

{% block page_title %}
    Judges
{% endblock %}

{% block judge_label %}
    Logout
{% endblock %}

{% block judge_link %}
    {% url 'logout' %}
{% endblock %}

{% block container %}
<div class="row">
  <div class="col-sm-offset-1 col-sm-10 col-xs-12">
    <ul id="tabsBar" class="nav nav-tabs nav-justified" role="tablist">
      <!-- Tab panel ids must end with 'TabPane' for setupTabHooks() to work -->
      <li role="presentation" class="active">
        <a href="#gameTabPane" aria-controls="gameTabPane" role="tab"
            data-toggle="tab">
          <span>
            Game
          </span>
        </a>
      </li>
      <li role="presentation">
        <a href="#stuffTabPane" aria-controls="stuffTabPane" role="tab"
            data-toggle="tab">
          <span>
            Stuff
          </span>
        </a>
      </li>
      <li role="presentation">
        <a href="#devicesTabPane" aria-controls="devicesTabPane" role="tab"
            data-toggle="tab">
          <span>
            Devices
          </span>
          <span
            id="devicesRedBadgeCount"
            class="hidden label label-danger"
          >
          </span>
          <span
            id="devicesYellowBadgeCount"
            class="hidden label label-warning"
          >
          </span>
        </a>
      </li>
      <li role="presentation">
        <a href="#brokerTabPane" aria-controls="brokerTabPane" role="tab"
            data-toggle="tab">
          <span>
            Broker
          </span>
        </a>
      </li>
      <li role="presentation">
        <a href="#judgesTabPane" aria-controls="judgesTabPane" role="tab"
            data-toggle="tab">
          <span>
            Judges
          </span>
        </a>
      </li>
    </ul>
  </div>
</div>

<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="gameTabPane">
    <div class="row">
      <div class="col-lg-offset-3 col-lg-6 col-md-offset-2 col-md-8
          col-sm-offset-1 col-sm-10 col-xs-12">

        <div class="row">
          <div class="col-xs-12">
            <p class="text-center help-block">
              The current server value of each field is shown below its input
              box.
              <br>
              Leave any timestamp blank to use the current server time when the
              command is run.
            </p>
            <div class="min-height-one-line">
              <h4 id="errorMessage" class="text-center">Connecting...</h4>
              <div id="commandResult" class="text-center">
                <h4 id="firstCommandResult"></h4>
                <h4 id="extraCommandResults"></h4>
              </div>
            </div>
          </div>
        </div>

        <hr class="hr-below-form">

        <form class="form-ajax-submit" method="post" action="{% url 'judge' %}">
          {% csrf_token %}
          <div class="row row-small-gutter vertical-center">

            <div class="col-sm-9 col-xs-12">

              <div class="row row-small-gutter vertical-center">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label sr-only" for="startTimeInput">
                      Start timestamp
                    </label>
                    <div class="input-group">
                      <div class="input-group-addon">
                        <span class="glyphicon glyphicon-time"
                            aria-hidden="true">
                        </span>
                      </div>
                      <input type="text" class="form-control"
                          id="startTimeInput" name="start_timestamp"
                          placeholder="Start timestamp">
                    </div>
                    <p id="startTimeSpan" class="judge-value text-center"
                        data-toggle="tooltip" data-placement="bottom">
                    </p>
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group text-center one-line-radio radio-required">
                    <label class="radio-inline"
                        title="Red defending Doherty. Yellow defending Wean.">
                      <input type="radio" name="territory" value="dw">
                      <span class="text-danger">DH</span>
                      /
                      <span class="text-warning">WeH</span>
                    </label>
                    <label class="radio-inline"
                        title="Red defending Wean. Yellow defending Doherty.">
                      <input type="radio" name="territory" value="wd">
                      <span class="text-danger">WeH</span>
                      /
                      <span class="text-warning">DH</span>
                    </label>
                    <p id="territorySpan" class="judge-value text-center"></p>
                  </div>
                </div>
              </div>

              <div class="row row-small-gutter">
                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label sr-only" for="numFlagsInput">
                      Number of flags
                    </label>
                    <div class="input-group">
                      <div class="input-group-addon">
                        <span class="glyphicon glyphicon-flag"
                            aria-hidden="true">
                        </span>
                      </div>
                      <input type="text" class="form-control input-required"
                          id="numFlagsInput" name="num_flags"
                          placeholder="Number of flags">
                    </div>
                    <span class="glyphicon glyphicon-remove form-control-feedback"
                        aria-hidden="true"></span>
                    <p id="numFlagsSpan" class="judge-value text-center"></p>
                  </div>
                </div>

                <div class="col-xs-6">
                  <div class="form-group">
                    <label class="control-label sr-only" for="gameNumInput">
                      Game number
                    </label>
                    <div class="input-group">
                      <div class="input-group-addon"><strong>#</strong></div>
                      <input type="text" class="form-control input-required"
                          id="gameNumInput" name="game_num"
                          placeholder="Game number">
                    </div>
                    <span class="glyphicon glyphicon-remove form-control-feedback"
                        aria-hidden="true"></span>
                    <p id="gameNumSpan" class="judge-value text-center"></p>
                  </div>
                </div>
              </div>

            </div>

            <div class="col-sm-3 col-xs-12">
              <div class="form-group text-center">
                <div class="checkbox checkbox-below-form">
                  <label>
                    <input type="checkbox" checked name="send_message"
                        value="on">
                    Send message
                  </label>
                </div>
                <div class="checkbox checkbox-below-form">
                  <label>
                    <input type="checkbox" checked name="zero_flags" value="on">
                    Set flags to 0
                  </label>
                </div>
                <button type="submit" class="center-block btn btn-primary">
                  Start Game
                </button>
              </div>
            </div>

          </div>
          <input type="hidden" name="command" value="start_game">
        </form>

        <hr class="hr-below-form">

        <div class="row row-small-gutter row-contains-vr">
          <div class="col-sm-9 col-xs-12">
            <form class="form-ajax-submit" method="post"
                action="{% url 'judge' %}">
              {% csrf_token %}
              <div class="row row-small-gutter">

                <div class="col-sm-9 col-xs-12">
                  <div class="row row-small-gutter">
                    <div class="col-xs-6">
                      <div class="form-group">
                        <label class="control-label sr-only"
                            for="redFlagsInput">
                          Red score
                        </label>
                        <div class="input-group">
                          <div class="input-group-addon">
                            <strong>R</strong>
                          </div>
                          <input type="text" class="form-control input-required"
                              id="redFlagsInput" name="red_flags"
                              placeholder="Red score">
                        </div>
                        <span class="glyphicon glyphicon-remove form-control-feedback"
                            aria-hidden="true"></span>
                        <p id="redFlagsSpan"
                            class="judge-value text-center">
                        </p>
                      </div>
                    </div>

                    <div class="col-xs-6">
                      <div class="form-group">
                        <label class="control-label sr-only"
                            for="yellowFlagsInput">
                          Yellow score
                        </label>
                        <div class="input-group">
                          <div class="input-group-addon">
                            <strong>Y</strong>
                          </div>
                          <input type="text" class="form-control input-required"
                              id="yellowFlagsInput" name="yellow_flags"
                              placeholder="Yellow score">
                        </div>
                        <span class="glyphicon glyphicon-remove form-control-feedback"
                            aria-hidden="true"></span>
                        <p id="yellowFlagsSpan"
                            class="judge-value text-center">
                        </p>
                      </div>
                    </div>
                  </div>

                  <p id="hiddenFlagsSpan"
                    class="judge-value-hidden text-center">
                  </p>

                </div>

                <div class="col-sm-3 col-xs-12">
                  <div class="form-group">
                    <button type="submit" class="center-block btn btn-primary">
                      Set Flags
                    </button>
                  </div>
                </div>

              </div>
              <input type="hidden" name="command" value="set_flags_number">
            </form>
          </div>

          <div><hr class="vr in-form"></div>

          <div class="col-sm-3 col-xs-12">
            <form class="form-ajax-submit" method="post"
                action="{% url 'judge' %}">
              {% csrf_token %}
              <div class="form-group">
                <button type="submit" class="center-block btn btn-success">
                  Set Flags to ?
                </button>
              </div>
              <input type="hidden" name="command" value="set_flags_hidden">
            </form>
          </div>
        </div>

        <hr class="hr-below-form">

        <div class="row row-small-gutter vertical-center">
          <div class="col-sm-9 col-xs-12">

            <form class="form-ajax-submit" method="post"
                action="{% url 'judge' %}" id="messageForm">
              {% csrf_token %}
              <div class="row row-small-gutter vertical-center">

                <div class="form-group col-xs-6">
                  <label class="control-label sr-only" for="messageTimeInput">
                    Message timestamp
                  </label>
                  <div class="input-group">
                    <div class="input-group-addon">
                      <span class="glyphicon glyphicon-time" aria-hidden="true">
                      </span>
                    </div>
                    <input type="text" class="form-control"
                        id="messageTimeInput" name="message_timestamp"
                        placeholder="Message timestamp">
                  </div>
                  <p id="playerMessageTimeSpan"
                    class="hidden judge-value text-center"
                    data-toggle="tooltip" data-placement="bottom">
                  </p>
                  <p id="jailMessageTimeSpan"
                    class="hidden judge-value text-center"
                    data-toggle="tooltip" data-placement="bottom">
                  </p>
                  <p id="bothMessageTimeSpan"
                    class="judge-value text-center"
                    data-toggle="tooltip" data-placement="bottom">
                  </p>
                </div>

                <div class="form-group text-center col-xs-6 two-line-radio">
                  <label class="radio-inline">
                    <input type="radio" name="message_type" value="player">
                    Players
                  </label>
                  <label class="radio-inline">
                    <input type="radio" name="message_type" value="jail">
                    Jail
                  </label>
                  <label class="radio-inline">
                    <input type="radio" name="message_type" value="both"
                      checked>
                    Both
                  </label>
                </div>

              </div>
              <div class="row row-small-gutter">

                <div class="form-group col-xs-12">
                  <label class="control-label sr-only" for="messageInput">
                    Message
                  </label>
                  <div class="input-group">
                    <div class="input-group-addon">
                      <span class="glyphicon glyphicon-comment"
                          aria-hidden="true">
                      </span>
                    </div>
                    <input type="text" class="form-control" id="messageInput"
                        name="message" placeholder="Message">
                  </div>
                  <p id="playerMessageSpan"
                    class="hidden judge-value text-center">
                  </p>
                  <p id="jailMessageSpan"
                    class="hidden judge-value text-center">
                  </p>
                  <p id="bothMessageSpan"
                    class="judge-value text-center">
                  </p>
                </div>

              </div>
              <input type="hidden" name="command" value="send_message">
            </form>
          </div>

          <div class="col-sm-3 col-xs-12">

            <div class="form-group text-center">
              <button type="submit" form="messageForm"
                  class="center-block btn btn-primary">
                Send Message
              </button>
              <div class="dropdown">
                <a role="button" data-target="#"
                    id="hideMessagesButton" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                  Hide messages...
                </a>
                <div class="dropdown-menu dropdown-form dropdown-menu-right"
                    aria-labelledby="hideMessagesButton">
                  <div class="container-fluid">
                    <div class="row">
                      <div class="col-xs-12 text-center">
                        <form class="form-inline form-ajax-submit" method="post"
                            action="{% url 'judge' %}">
                          {% csrf_token %}
                          <div class="form-group">
                            <label class="control-label"
                                for="hideMessagesTimeInput">
                                Sent before
                            </label>
                            <div class="input-group">
                              <div class="input-group-addon">
                                <span class="glyphicon glyphicon-time"
                                    aria-hidden="true">
                                </span>
                              </div>
                              <input type="text" class="form-control"
                                  id="hideMessagesTimeInput"
                                  name="clear_timestamp"
                                  placeholder="Timestamp">
                            </div>
                            <p id="hideMessagesTimeSpan"
                                class="judge-value-xs"
                                data-toggle="tooltip" data-placement="bottom">
                            </p>
                          </div>
                          <button type="submit"
                              class="btn btn-primary">
                              Submit
                          </button>
                          <input type="hidden" name="command"
                              value="clear_messages">
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <hr class="hr-below-form">

        <div class="row row-small-gutter row-contains-vr">
          <div class="col-sm-8 col-xs-12">
            <form class="form-ajax-submit" method="post"
                action="{% url 'judge' %}">
              {% csrf_token %}
              <div class="row row-small-gutter">

                <div class="col-sm-5 col-xs-5">
                  <div class="form-group">
                    <label class="control-label sr-only" for="endTimeInput">
                      End timestamp
                    </label>
                    <div class="input-group">
                      <div class="input-group-addon">
                        <span class="glyphicon glyphicon-time"
                            aria-hidden="true">
                        </span>
                      </div>
                      <input type="text" class="form-control" id="endTimeInput"
                          name="end_timestamp" placeholder="End timestamp">
                    </div>
                    <p id="endTimeSpan" class="judge-value text-center"
                        data-toggle="tooltip" data-placement="bottom">
                    </p>
                  </div>
                </div>

                <div class="col-sm-3 col-xs-3">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" name="hide_flags" value="on">
                      Hide flags
                    </label>
                  </div>
                </div>

                <div class="col-sm-3 col-xs-4">
                  <div class="form-group">
                    <button type="submit" class="center-block btn btn-warning">
                      End Game
                    </button>
                  </div>
                </div>

              </div>
              <input type="hidden" name="command" value="end_game">
            </form>
          </div>

          <div class="col-sm-1"><hr class="vr in-form"></div>

          <div class="col-xs-12 visible-xs">
            <hr class="hr-below-form">
          </div>

          <div class="col-sm-3 col-xs-12">
            <form class="form-ajax-submit" method="post"
                action="{% url 'judge' %}">
              {% csrf_token %}
              <div class="form-group">
                <button type="submit" class="center-block btn btn-danger">
                  No Game
                </button>
              </div>
              <input type="hidden" name="command" value="no_game">
            </form>
          </div>
        </div>

        <hr class="hr-below-form">

        <div id="flagsPanel" class="panel panel-default">
          <div class="panel-heading">
            <h1 class="panel-title">Flags</h1>
          </div>
          <div v-if="numFlags !== flags.length" class="panel-body">
            <div class="alert alert-info mb-0 flags-alert text-center"
                role="alert">
              <span class="inline-block flags-alert-contents">
                <span class="inline-block">
                  The number of flags has changed to [[ numFlags ]].
                </span>
                <span class="inline-block">
                  Click to clear and update the table.
                </span>
              </span>
              <button type="button"
                  class="btn btn-info btn-sm flags-alert-contents inline-block"
                  @click="fillFlagsArray">
                Update
              </button>
            </div>
          </div>
          <div v-if="flags.length === 0" class="panel-body text-center">
            No number of flags set
          </div>
          <div v-if="flags.length" class="table-responsive">
            <table class="table table-bordered table-condensed">
              <thead>
                <tr>
                  <th>
                    <button type="button"
                        class="btn btn-default btn-xs mt-0"
                        @click="uncheckFlagsArray">
                      Clear
                    </button>
                  </th>
                  <th v-for="flag in flags" :key="'flag-letter-' + flag.letter"
                      class="text-center">
                    [[ flag.letter ]]
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr class="danger">
                  <th>
                    Red
                  </th>
                  <td v-for="flag in flags" :key="'flag-red-' + flag.letter"
                      class="text-center">
                    <input v-model="flag.red" type="checkbox"
                        :aria-label="'Red flag ' + flag.letter">
                  </td>
                </tr>
                <tr class="warning">
                  <th>
                    Yellow
                  </th>
                  <td v-for="flag in flags" :key="'flag-yellow-' + flag.letter"
                      class="text-center">
                    <input v-model="flag.yellow" type="checkbox"
                        :aria-label="'Yellow flag ' + flag.letter">
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="stuffTabPane">
    <div class="row">
      <div class="col-sm-offset-1 col-sm-10 col-xs-12">
        <form id="stuffForm" class="form-no-submit" method="post"
            action="{% url 'judge' %}">
          {% csrf_token %}

          <div class="row" id="stuffTables">
            <div class="col-md-8 col-xs-12">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <h1 class="panel-title">Stuff</h1>
                </div>
                <table class="table table-bordered">
                  <tr>
                    <th class="bg-grey"></th>
                    <th class="danger">Red</th>
                    <th class="success">Green</th>
                    <th class="info">Blue</th>
                    <th>White</th>
                  </tr>
                  <tr>
                    <th>Wands</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_wands.html_name }}"
                        value="{{ stuff_totals.red_wands }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.green_wands.html_name }}"
                        value="{{ stuff_totals.green_wands }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.blue_wands.html_name }}"
                        value="{{ stuff_totals.blue_wands }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.white_wands.html_name }}"
                        value="{{ stuff_totals.white_wands }}">
                    </td>
                  </tr>
                  <tr>
                    <th>Belts</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_belts.html_name }}"
                        value="{{ stuff_totals.red_belts }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.green_belts.html_name }}"
                        value="{{ stuff_totals.green_belts }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.blue_belts.html_name }}"
                        value="{{ stuff_totals.blue_belts }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.white_belts.html_name }}"
                        value="{{ stuff_totals.white_belts }}">
                    </td>
                  </tr>
                  <tr>
                    <th>Potions</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_potions.html_name }}"
                        value="{{ stuff_totals.red_potions }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.green_potions.html_name }}"
                        value="{{ stuff_totals.green_potions }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.blue_potions.html_name }}"
                        value="{{ stuff_totals.blue_potions }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.white_potions.html_name }}"
                        value="{{ stuff_totals.white_potions }}">
                    </td>
                  </tr>
                </table>
              </div>

              <div class="row">
                <div class="col-md-6 col-xs-12">
                  <div class="panel panel-primary">
                    <div class="panel-heading">
                      <h1 class="panel-title">Flags</h1>
                    </div>
                    <table class="table table-bordered">
                      <tr>
                        <th class="bg-grey"></th>
                        <th class="danger">Red</th>
                        <th class="warning">Yellow</th>
                      </tr>
                      <tr>
                        <th>Flags</th>
                        <td>
                          <input type="number" class="form-control">
                          <hr>
                          <input type="number" class="form-control"
                            name="{{ stuff_form.red_flags.html_name }}"
                            value="{{ stuff_totals.red_flags }}">
                        </td>
                        <td>
                          <input type="number" class="form-control">
                          <hr>
                          <input type="number" class="form-control"
                            name="{{ stuff_form.yellow_flags.html_name }}"
                            value="{{ stuff_totals.yellow_flags }}">
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>

                <div class="col-md-6 col-xs-12">
                  <div class="panel panel-primary">
                    <div class="panel-heading">
                      <h1 class="panel-title">Hats</h1>
                    </div>
                    <table class="table table-bordered">
                      <tr>
                        <th class="bg-grey"></th>
                        <th class="danger">Red</th>
                        <th class="warning">Yellow</th>
                      </tr>
                      <tr>
                        <th>Hats</th>
                        <td>
                          <input type="number" class="form-control">
                          <hr>
                          <input type="number" class="form-control"
                            name="{{ stuff_form.red_hats.html_name }}"
                            value="{{ stuff_totals.red_hats }}">
                        </td>
                        <td>
                          <input type="number" class="form-control">
                          <hr>
                          <input type="number" class="form-control"
                            name="{{ stuff_form.yellow_hats.html_name }}"
                            value="{{ stuff_totals.yellow_hats }}">
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-4 col-xs-12">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <h1 class="panel-title">Glyphs</h1>
                </div>
                <table class="table table-bordered">
                  <tr>
                    <th class="bg-grey"></th>
                    <th class="danger">Red</th>
                    <th class="warning">Yellow</th>
                  </tr>
                  <tr>
                    <th>Jail</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_jail.html_name }}"
                        value="{{ stuff_totals.red_jail }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.yellow_jail.html_name }}"
                        value="{{ stuff_totals.yellow_jail }}">
                    </td>
                  </tr>
                  <tr>
                    <th>Yukko</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_yukko.html_name }}"
                        value="{{ stuff_totals.red_yukko }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.yellow_yukko.html_name }}"
                        value="{{ stuff_totals.yellow_yukko }}">
                    </td>
                  </tr>
                  <tr>
                    <th>Alarm</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_alarm.html_name }}"
                        value="{{ stuff_totals.red_alarm }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.yellow_alarm.html_name }}"
                        value="{{ stuff_totals.yellow_alarm }}">
                    </td>
                  </tr>
                  <tr>
                    <th>Gotcha</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_gotcha.html_name }}"
                        value="{{ stuff_totals.red_gotcha }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.yellow_gotcha.html_name }}"
                        value="{{ stuff_totals.yellow_gotcha }}">
                    </td>
                  </tr>
                  <tr>
                    <th>Recharge</th>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.red_recharge.html_name }}"
                        value="{{ stuff_totals.red_recharge }}">
                    </td>
                    <td>
                      <input type="number" class="form-control">
                      <hr>
                      <input type="number" class="form-control"
                        name="{{ stuff_form.yellow_recharge.html_name }}"
                        value="{{ stuff_totals.yellow_recharge }}">
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          </div>

          <div class="row vertical-center">
            <div class="col-xs-6">
              <div class="form-group">
                <button id="clearCountsButton" type="button"
                    class="btn btn-warning center-block">
                  Clear Counts
                </button>
              </div>
            </div>

            <div class="col-xs-6">
              <div class="form-group">
                <button id="lockTotalsButton" type="button"
                    class="btn btn-info center-block">
                  <span id="lockUnlockText"></span> Totals
                </button>
              </div>
            </div>
          </div>

          <div class="row vertical-center">
            <div class="col-xs-12">
              <button id="saveTotalsButton" type="button"
                  class="btn btn-primary center-block">
                Save Totals
              </button>
              <p id="saveTotalsResult" class="text-center"></p>
              <p class="text-center help-block">
                Store the current totals (denominators) on the server so the
                page loads with them pre-populated next time.
              </p>
            </div>
          </div>

          <input type="hidden" name="command" value="save_count_totals">
        </form>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="devicesTabPane">
    <div class="row">
      <div class="col-lg-offset-3 col-lg-6 col-md-offset-2 col-md-8
          col-sm-offset-1 col-sm-10 col-xs-12">
        <div v-if="errorConnecting" class="alert alert-danger" role="alert">
          Error connecting to the broker. The below may be incorrect or
          out-of-date.
        </div>
        <div class="panel panel-default">
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Time</th>
                  <th>MAC</th>
                  <th>Location</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="device in deviceRows"
                  :key="device.name"
                  :class="device.class"
                >
                  <th>[[ device.name ]]</th>
                  <td>[[ device.status ]]</td>
                  <td>[[ device.time ]]</td>
                  <td>[[ device.mac ]]</td>
                  <td>
                    <span v-if="device.location === 'w'">
                      Wean
                    </span>
                    <span v-else-if="device.location === 'd'">
                      Doherty
                    </span>
                    <code v-else-if="device.location">
                      [[ device.location ]]
                    </code>
                  </td>
                  <td>
                    <span v-if="device.role === 'j'">
                      Jail
                    </span>
                    <code v-else-if="device.role">
                      [[ device.role ]]
                    </code>
                  </td>
                </tr>
                <tr v-if="!deviceRows.length">
                  <th colspan="6" class="text-center">
                    No device information found
                  </th>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="text-center lead">
          <p>
            Broker Timestamp:
            <span v-if="timesync === null">
              <em>none</em>
            </span>
            <span v-else>
              [[ timesync ]]
              <span v-if="timesyncFormatted">
                ([[ timesyncFormatted ]])
              </span>
            </span>
          </p>
          <p>
            Server Time:
            <span v-if="!serverNow">
              <em>none</em>
            </span>
            <span v-else>
              [[ serverNow ]]
              <span v-if="serverNowFormatted">
                ([[ serverNowFormatted ]])
              </span>
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="brokerTabPane">
    <div class="row">
      <div class="col-sm-offset-1 col-sm-10 col-xs-12">
        <div v-if="errorConnecting" class="alert alert-danger" role="alert">
          Error connecting to the broker. The below topics may be incorrect or
          out-of-date.
        </div>
        <ctfws-topic-tree :topics="topics" topic-name="" full-name=""
            class="well font-family-monospace">
        </ctfws-topic-tree>
      </div>
    </div>
  </div>

  <div role="tabpanel" class="tab-pane" id="judgesTabPane">
    <div class="row">
      <div class="col-sm-offset-1 col-sm-10 col-xs-12">
        <div class="row">
          <div class="col-xs-12 col-lg-9">
            <div class="panel panel-success">
              <div class="panel-heading">
                <h1 class="panel-title">
                  Assignments
                  <span class="pull-right">
                    <span v-if="successMessage">
                      [[ successMessage]]
                    </span>
                    <span v-if="errorMessage" class="text-danger">
                      [[ errorMessage ]]
                    </span>
                    <span v-if="saving" class="text-info">
                      Saving...
                    </span>
                    <span v-else-if="changes" class="text-warning ml-7">
                      Unsaved changes
                    </span>
                  </span>
                </h1>
              </div>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th class="nowrap vertical-align-middle">
                        <button v-if="!editing" type="button"
                            class="btn btn-info btn-sm mt-0"
                            @click="editing = true">
                          Edit
                        </button>
                        <button v-if="editing" type="button"
                            class="btn btn-success btn-sm mt-0"
                            @click="saveAssignments">
                          Save
                        </button>
                        <button v-if="editing" type="button"
                            class="btn btn-warning btn-sm mt-0"
                            @click="clearAssignments">
                          Clear
                        </button>
                      </th>
                      <th v-for="(game, index) in assignments" :key="index"
                          class="vertical-align-middle">
                        <span class="inline-block">Game [[ index + 1]]</span>
                        <button v-if="copySupported && !editing"
                            :data-clipboard-text="copyText[index]" type="button"
                            class="btn btn-default btn-xs mt-0 assignments-copy-btn">
                          Copy
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="role in roles" :key="role.key">
                      <th class="nowrap vertical-align-middle">
                        [[ role.display ]]
                      </th>
                      <td v-for="(game, index) in assignments"
                          :key="role.key + index"
                          :class="tableDataClasses(role, index)">
                        <input v-if="editing" v-model="game[role.key]"
                            type="text" class="form-control input-sm"
                            autocomplete="off">
                        <span v-else>
                          [[ game[role.key] ]]
                        </span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-xs-12 col-lg-3">
            <div class="panel panel-info">
              <div class="panel-heading">
                <h1 class="panel-title">Flag Placement</h1>
              </div>
              <ul class="list-group">
                <li class="list-group-item">
                  No higher than six feet
                </li>
                <li class="list-group-item">
                  Visible from most angles
                </li>
                <li class="list-group-item">
                  Not within ten feet of a glyph
                </li>
                <li class="list-group-item">
                  In a hallway or room with two exits
                </li>
                <li class="list-group-item">
                  No more than one per room or hallway
                </li>
                <li class="list-group-item">
                  Removable with one smooth motion
                  <span class="text-muted">
                    (cannot be pinned to boards)
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}
